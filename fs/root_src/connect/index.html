<!DOCTYPE html>
<html lang="en">
<head>
<title>Network setup info.</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
<link href="css/normalize.css" rel="stylesheet" type="text/css" />
<link href="css/custom.css" rel="stylesheet" type="text/css" />
</head>
<body>
	<nav role="navigation">
		<a href="#" class="hidden-menu" onclick="ToggleHide('menu');" id="hidden-menu">&#9776;</a>
		<ul id="menu">
			<li><a href="index.html" class="menu">WIFISwitch</a></li>
			<li><a href="net.html" class="menu">Network</a></li>
			<li><a href="ap.html" class="menu">Stand-alone</a></li>
			<li><a href="restart.html" class="menu">Restart</a></li>			
			<li><a href="about.html" class="menu">About</a></li>
		</ul>
	</nav>
	<section>
	<!-- include header.html -->
		<h3>WIFISwitch configuration.</h3>
		<p>Mode: <span><strong id="mode">unknown</strong></span></p>
		<p>Firmware version: <span id="fw_ver">0.0.0</span></p>
		<p>IP address: <span id="ip_addr">none</span></p>
		<p>Network name: <span id="network">none</span></p>
		<p>Hostname: <span id="hostname">none</span></p>
		<p><button type="button" onclick="switchMode()">Change mode</button></p>
		<p class=message" id="status"><strong>Idle.</strong> &iexcl;Venga, venga!</p>
		<br />
	<!-- include footer.html -->
	</section>
	<footer class="inverted">
		<small><span class="copyright">&copy; Copyright 2015 Martin Bo Kristensen Gr&oslash;nholdt.</span><a href="LICENSE.zip" class="license inverted">Read license (compressed).</a></small>
	</footer> 
	<script src="js/menu.js" type="text/javascript"></script>
	<script type="text/javascript">
		//Create WebSocket address from http uri.
		var loc = window.location
		var ws_uri;
		if (loc.protocol === "https:") {
			ws_uri = "wss:";
		} else {
			ws_uri = "ws:";
		}
		ws_uri += "//" + loc.host + "/ws/";
        var socket = new WebSocket(ws_uri, "wifiswitch");
        var statusMsg = document.getElementById("status");
        
        statusMsg.innerHTML = "Connecting...</strong>";

		function switchMode() {
			var msg = {};
			msg.type = "fw";
			
			if (mode.innerHTML === "<strong>network</strong>") {
				msg.mode = "ap";
			}
			else if (mode.innerHTML === "<strong>stand-alone</strong>") {
				msg.mode = "station";
			}
			socket.send(JSON.stringify(msg));
			
			console.log("Switch mode: " + msg.mode);
			statusMsg.className = "message";
			statusMsg.innerHTML = "<strong>Saving.</strong>";
		}
		
        socket.onopen = function(event) {
			console.log("Connected to backend");
			
			socket.send(JSON.stringify({type: "fw"}));
			
			statusMsg.className = "message success";
			statusMsg.innerHTML = "<strong>Connected.</strong>";
        };
        
        // Display messages received from the server
        socket.onmessage = function(event) {
			console.log("Backend message:" + event.data);
			
			var msg = JSON.parse(event.data);
			if (msg.type === "fw") {
				var mode = document.getElementById("mode");
				
				if (msg.mode === "ap") {
					console.log("In AP mode.");
					mode.innerHTML = "<strong>stand-alone</strong>";
					socket.send(JSON.stringify({type: "ap"}));
				}
				else if (msg.mode === "station") {
					console.log("In station mode.");
					mode.innerHTML = "<strong>network</strong>";
					socket.send(JSON.stringify({type: "station"}));
				}
				document.getElementById("fw_ver").innerHTML = msg.ver;
				statusMsg.className = "message success";
				statusMsg.innerHTML = "<strong>Updated.</strong>";
				
			}
			if (msg.type === "ap") {
				var ip = document.getElementById("ip_addr");
				ip.innerHTML = msg.ip;
				
				var ssid = document.getElementById("network");
				ssid.innerHTML = msg.ssid;

				var hostname = document.getElementById("hostname");
				hostname.innerHTML = msg.hostname;
				
				statusMsg.className = "message success";
				statusMsg.innerHTML = "<strong>Updated.</strong>";
			}
			if (msg.type === "station") {
				var ip = document.getElementById("ip_addr");
				ip.innerHTML = msg.ip;
				
				var ssid = document.getElementById("network");
				ssid.innerHTML = msg.ssid;

				var hostname = document.getElementById("hostname");
				hostname.innerHTML = msg.hostname;
				
				statusMsg.className = "message success";
				statusMsg.innerHTML = "<strong>Updated.</strong>";
			}				
        };

        // Display any errors that occur
        socket.onerror = function(event) {
			console.log("Backend error:" + event);
			statusMsg.className += "message error";
			statusMsg.innerHTML = "<strong>Error:</strong> " + event;
        };
	</script>
	<noscript>Sorry I need JavaScript!</noscript>
</body>
<html></html>
