<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Network connection setup.</title>
<link href="css/normalize.css" rel="stylesheet" type="text/css" />
<link href="css/custom.css" rel="stylesheet" type="text/css" />
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
</head>
<body>
	<nav role="navigation">
		<a href="#" class="hidden-menu" onclick="ToggleHide('menu');" id="hidden-menu">&#9776;</a>
		<ul id="menu">
			<li><a href="index.html" class="menu">WIFISwitch</a></li>
			<li><a href="net.html" class="menu">Network</a></li>
			<li><a href="ap.html" class="menu">Stand-alone</a></li>
			<li><a href="restart.html" class="menu">Restart</a></li>			
			<li><a href="about.html" class="menu">About</a></li>
		</ul>
	</nav>
	<section>
		<h3>Network connection setup.</h3>
		<p>Network:<br />
		<select id="networks"><option value="nets">Networks...</option></select></p
		<p>Hostname:<br />
		<input type="text" id="hostname" maxlength="32"></p>
		<p>Password:<br />
		<input type="password" id="passwd" maxlength="64"></p>
		<p><button type="button" onclick="setStation()">Save</button></p>
		<p class="message" id="status">
		</p>
		<br />
	</section>
	<footer class="inverted">
		<small><span class="copyright">&copy; Copyright 2015 Martin Bo Kristensen Gr&oslash;nholdt.</span><a href="LICENSE.zip" class="license inverted">Read license (compressed).</a></small>
	</footer>
	<script src="js/menu.js" type="text/javascript"></script>
	<script type="text/javascript">
		//Create WebSocket address from http uri.
		var loc = window.location
		var ws_uri;
		if (loc.protocol === "https:") {
			ws_uri = "wss:";
		} else {
			ws_uri = "ws:";
		}
		ws_uri += "//" + loc.host + "/ws/";
        var socket = new WebSocket(ws_uri, "wifiswitch");
        var statusMsg = document.getElementById("status");
        
        statusMsg.innerHTML = "Connecting...</strong>";
        
        function populateNetworks(networks) {
			var netSelect = document.getElementById("networks");

			netSelect.options.length = 0;

			if (networks.length === 0) {
				netSelect.add(new Option(
						"Scanning...", "", false, false));
				return;
			}
			for (var i = 0; i < networks.length; i++) {
				netSelect.add(new Option(
						networks[i], networks[i], false, false));
			}
			statusMsg.className = "message success";
			statusMsg.innerHTML = "<strong>Done!</strong> WIFI networks have been scanned.";

		}

        socket.onopen = function(event) {
			console.log("Connected to backend");
			
			socket.send(JSON.stringify({type: "networks"}));
			
			statusMsg.className = "message"
			statusMsg.innerHTML = "Scanning!</strong> Scanning for WIFI networks.";        };
        
        // Display messages received from the server
        socket.onmessage = function(event) {
			console.log("Backend message:" + event.data);
			
			var msg = JSON.parse(event.data);
			if (msg.type === "networks") {
				populateNetworks(msg.ssids);
				socket.send(JSON.stringify({type: "station"}));
			}
			if (msg.type === "station") {
				document.getElementById("networks").add(new Option(
						msg.ssid, msg.ssid, true, true));
				document.getElementById("networks").value = msg.ssid;
				document.getElementById("hostname").value = msg.hostname;
				statusMsg.className = "message success";
				statusMsg.innerHTML = "<strong>Updated.</strong>";
			}
        };

        // Display any errors that occur
        socket.onerror = function(event) {
			console.log("Backend error:" + event);
			statusMsg.className += "message error";
			statusMsg.innerHTML = "<strong>Error:</strong> " + event;
        };
        
        function setStation() {
			var passwd = document.getElementById("passwd").value;
			var msg = {};
			msg.type = "station";
			msg.ssid = document.getElementById("networks").value;
			msg.hostname = document.getElementById("hostname").value;
			if (passwd) {
				msg.passwd = passwd;
			}

			socket.send(JSON.stringify(msg));
			statusMsg.className = "message";
			statusMsg.innerHTML = "<strong>Saving.</strong>";
		}
	</script>
	<noscript>Sorry I need JavaScript!</noscript>
</body>
<html></html>
